---
- name: Install ELK Stack 8.x on Ubuntu 24.04 via Morpheus
  hosts: all
  become: true
  vars:
    elastic_version: "8.19.9"
    elastic_password: "{{ morpheus.customOptions.elasticPassword | default('elastic') }}"
    kibana_encryption_key: "{{ morpheus.customOptions.kibanaKey | default('default_super_long_kibana_key') }}"
    reporting_encryption_key: "{{ morpheus.customOptions.reportingKey | default('default_super_long_reporting_key') }}"
    proxy_url: "{{ morpheus.customOptions.proxyUrl | default('') }}"

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
      environment:
        http_proxy: "{{ proxy_url }}"
        https_proxy: "{{ proxy_url }}"

    - name: Install dependencies
      apt:
        name: "{{ item }}"
        state: present
      loop:
        - apt-transport-https
        - openjdk-17-jdk
        - wget
        - gnupg
      environment:
        http_proxy: "{{ proxy_url }}"
        https_proxy: "{{ proxy_url }}"

    - name: Download Elastic GPG key
      get_url:
        url: https://artifacts.elastic.co/GPG-KEY-elasticsearch
        dest: /tmp/GPG-KEY-elasticsearch
        validate_certs: no
      environment:
        http_proxy: "{{ proxy_url }}"
        https_proxy: "{{ proxy_url }}"

    - name: Add Elastic GPG key locally
      apt_key:
        file: /tmp/GPG-KEY-elasticsearch
        state: present

    - name: Add Elastic repository
      apt_repository:
        repo: "deb https://artifacts.elastic.co/packages/{{ elastic_version }}/apt stable main"
        state: present
        filename: "elastic-{{ elastic_version }}"

    - name: Update apt cache after adding Elastic repo
      apt:
        update_cache: yes

    - name: Install Elasticsearch, Kibana, Logstash
      apt:
        name: "{{ item }}"
        state: present
      loop:
        - elasticsearch
        - kibana
        - logstash

    - name: Configure Kibana
      lineinfile:
        path: /etc/kibana/kibana.yml
        create: yes
        line: "{{ item }}"
      loop:
        - 'server.host: "0.0.0.0"'
        - 'elasticsearch.hosts: ["https://localhost:9200"]'
        - 'elasticsearch.username: "elastic"'
        - 'elasticsearch.password: "{{ elastic_password }}"'
        - 'xpack.encryptedSavedObjects.encryptionKey: "{{ kibana_encryption_key }}"'
        - 'xpack.reporting.encryptionKey: "{{ reporting_encryption_key }}"'
        - 'elasticsearch.ssl.verificationMode: "none"'

    - name: Create Elasticsearch systemd override directory
      file:
        path: /etc/systemd/system/elasticsearch.service.d
        state: directory
        mode: '0755'

    - name: Configure Elasticsearch service with proxy
      copy:
        content: |
          [Service]
          Environment="NO_PROXY=localhost,127.0.0.1"
        dest: /etc/systemd/system/elasticsearch.service.d/http-proxy.conf
        mode: '0644'

    - name: Reload systemd daemon
      systemd:
        daemon_reload: yes

    - name: Enable and start Elasticsearch
      systemd:
        name: elasticsearch
        state: started
        enabled: yes

    - name: Enable and start Kibana
      systemd:
        name: kibana
        state: started
        enabled: yes

    - name: Enable and start Logstash
      systemd:
        name: logstash
        state: started
        enabled: yes

    - name: Wait for Elasticsearch to start
      wait_for:
        port: 9200
        delay: 10
        timeout: 300

    - name: Display message
      debug:
        msg: "ELK Stack installation complete. Access Kibana at http://<VM_IP>:5601"
